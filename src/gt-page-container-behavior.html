<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../imports/gt.html">

<script>

  GT.PageContainerBehavior = {
    properties: {

      /**
       * The name of the page we are on.
       */
      pageName: {
        type: String,
        reflectToAttribute: true,
        observer: 'pageChanged'
      },

      /**
       * The pages element that contains the pages.
       */
      pages: {
        type: HTMLElement,
        value: function() {
          return this.$.pages
        }
      },

      /**
       * The name of the main page - the page to be displayed by default.
       */
      mainPageName: {
        type: String,
        value: 'home'
      },

      /**
       * The page that is currently being displayed.
       */
      renderedPageName: {
        type: String,
      },

      /**
       * State's whether or not this page container has been succesfully initialised.
       */
      isContainerInitialised: {
        type: Boolean,
        value: false,
        notify: true,
        readOnly: true
      },

      /**
       * The classes route.
       */
      route: Object,

      /**
       * The data contained in the route.
       */
      routeData: Object,

      /**
       * The subroute the app is on.
       */
      subroute: Object
    },

    observers: [
      '_routePageChanged(routeData.page)'
    ],

    /**
     * This method must be called once the page container has finished loading.
     * This will then let the page element itself start loading.
     */
    pageContainerReady: function() {
      this._setIsContainerInitialised(true);
      this.fire('page-container-loaded');
    },

    /**
     * This method should be called if an error occurs while initialising the page.
     */
    pageContainerError: function() {
      this._setIsContainerInitialised(false);
      this.fire('page-container-error');
    },

    /**
     * Called when the route data's page is changed.
     */
    _routePageChanged: function(urlRoute) {
      var updatePageName = function() {
        document.activeElement.blur();
        this.pageName = this.findPageNameForRoute(urlRoute);
        this.removeEventListener('page-container-loaded', updatePageName);
      }.bind(this);

      if (this.isContainerInitialised) {
        updatePageName();
      } else {
        this.addEventListener('page-container-loaded', updatePageName);
      }
    },

    /**
     * Find the page name for the given url.
     */
    findPageNameForRoute: function(urlRoute) {
      return urlRoute || this.mainPageName;
    },

    /**
     * Returns the renderedPageName's element.
     *
     * @param {Boolean} deep
     * @returns {HTMLElement}
     */
    getRenderedPageElement: function(deep) {
      if (deep === undefined) {
        deep = false;
      }
      return this._getPageElementImpl(this.renderedPageName, deep);
    },

    /**
     * Returns the pageName's element.
     *
     * @param {Boolean} deep
     * @returns {HTMLElement}
     */
    getPageElement: function(deep) {
      if (deep === undefined) {
        deep = false;
      }
      return this._getPageElementImpl(this.pageName, deep);
    },

    /**
     * Implemtation of getPageElement and getRenderedPageElement.
     *
     * @param {String} name
     * @param {Boolean} deep
     * @returns {HTMLElement}
     */
    _getPageElementImpl: function(name, deep) {
      var pe = Polymer.dom(this.pages).querySelector('[name="' + name + '"]');

      if (deep) {
        while (pe && pe.pages && pe.renderedPageName && pe.getRenderedPageElement instanceof Function) {
          var deepPe = Polymer.dom(pe.pages).querySelector('[name="' + name + '"]');
          if (deepPe !== null) {
            pe = deepPe;
          } else {
            break;
          }
        }
      }
      return pe;
    }
  };
</script>
