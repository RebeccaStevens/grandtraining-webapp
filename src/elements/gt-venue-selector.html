<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-from-top-animation.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="../../styles/gt-styles.html">
<link rel="import" href="../../imports/gt.html">
<link rel="import" href="../gt-element-common-behavior.html">

<dom-module id="gt-venue-selector">
  <template>
    <style include="gt-styles">
      :host {
        display: block;
      }
      #card {
        width: 100%;
        --paper-card-content: {
          padding-top: 0;
        };
      }
      #card .card-content {
        @apply(--layout-horizontal);
      }
      #card .card-content paper-dropdown-menu {
        margin: 0 0.5em;
        @apply(--layout-flex);
      }
      #card .card-content paper-dropdown-menu:first-child {
        margin-left: 0;
      }
      #card .card-content paper-dropdown-menu:last-child {
        margin-right: 0;
      }
    </style>

    <paper-card id="card" heading="Venue Selector">
      <div class="card-content">
        <paper-dropdown-menu id="regionSelector" label="Region">
          <paper-listbox class="dropdown-content" attr-for-selected="regionName" attr-for-item-title="regionName" on-iron-select="_regionSelected">
            <template is="dom-repeat" items="[[regions]]" as="region">
              <paper-item region-name="[[region.name]]">[[region.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu id="venueSelector" label="Venue" disabled$="[[_disableVenueSelector]]">
          <paper-listbox class="dropdown-content" attr-for-selected="venueId" attr-for-item-title="venueId" on-iron-select="_venueSelected">
            <template is="dom-repeat" items="[[venues]]" as="venue">
              <paper-item venue-id="[[venue.id]]">[[venue.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
    </paper-card>
  </template>

  <script>
    Polymer({
      is: 'gt-venue-selector',

      behaviors: [
        GT.ElementCommonBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {

        /**
         * The gloabel regions object
         */
        _globalRegions: {
          type: Object,
          observer: '_gloabelRegionsChanged',
          statePath: 'config.regions'
        },

        /**
         * The selected venue.
         */
        _venue: {
          type: Object,
          observer: '_venueChanged',
          statePath: 'venue'
        },

        /**
         * The selected region.
         */
        _region: {
          type: Object,
          observer: '_regionChanged'
        },

        /**
         * A list of the regions the user can choose from.
         */
        regions: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },

        /**
         * A list of the venues in the selected region the user can choose from.
         */
        venues: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },

        /**
         * States whether or not he VenueSelector should be disabled.
         */
        _disableVenueSelector: {
          type: Boolean,
          value: true
        },

        /**
         * The animations this element has.
         */
        animationConfig: {
          value: function() {
            return {
              entry: {
                name: 'slide-from-top-animation',
                node: this,
                timing: {
                  delay: 0,
                  duration: GT.animation.entryDuration
                }
              },
              exit: [
                {
                  name: 'slide-up-animation',
                  node: this,
                  timing: {
                    delay: 0,
                    duration: GT.animation.exitDuration
                  }
                },
                {
                  name: 'fade-out-animation',
                  node: this,
                  timing: {
                    delay: 0,
                    duration: GT.animation.exitDuration
                  }
                }
              ]
            };
          }
        }
      },

      listeners: {
        'neon-animation-finish': '_onNeonAnimationFinish'
      },

      /**
       * Get the region name of the selected region.
       *
       * @return {String}
       */
      get selectedRegionName() {
        if (this.$.regionSelector.contentElement.selected) {
          return this.$.regionSelector.contentElement.selected;
        }
        return null;
      },

      /**
       * Get the venue id of the selected venue.
       *
       * @return {String}
       */
      get selectedVenueId() {
        if (this.$.venueSelector.contentElement.selected) {
          return this.$.venueSelector.contentElement.selected;
        }
        return null;
      },

      /**
       * Show this element.
       */
      show: function() {
        this.style.display = '';
        this.cancelAnimation();
        this.playAnimation('entry');
      },

      /**
       * Hide this element.
       */
      hide: function() {
        this._hidding = true;
        this.cancelAnimation();
        this.playAnimation('exit');
      },

      /**
       * Called when an animation finishes playing.
       */
      _onNeonAnimationFinish: function() {
        if (this._hidding) {
          this._hidding = false;
          this.style.display = 'none';
        }
      },

      /**
       * Called when `_gloabelRegions` changes.
       */
      _gloabelRegionsChanged: function(regions) {
        var regionArray = [];
        for (var key in regions) {
          var region = {
            name: key,
            venues: regions[key]
          };

          regionArray.push(region);
        }
        this.set('regions', regionArray);
      },

      /**
       * Called when `_region` changes.
       */
      _regionChanged: function(region) {
        this.venues = region.venues;

        this.$.venueSelector.contentElement.select(-1);

        if (region.venues.length === 1) {
          setTimeout(function() {
            this.$.venueSelector.contentElement.select(this.$.venueSelector.contentElement.items[0].venueId);
          }.bind(this), 0);
        }
      },

      /**
       * Called when `venue` changes.
       */
      _venueChanged: function(venue) {
        if (!venue) {
          return;
        }

        if (this.regions.length === 0) {
          return;
        }

        var regions = this.regions;
        var region;
        var i = 0;
        for (region in regions) {
          if (regions[region].name === venue.region) {
            this.$.regionSelector.contentElement.select(venue.region);
            break;
          }
          i++;
        }

        // wait for the venueSelector to be populated
        setTimeout(function() {
          var venues = regions[region].venues;
          var j = 0;
          for (var v in venues) {
            if (venues[v].id === venue.id) {
              this.$.venueSelector.contentElement.select(venue.id);
              break;
            }
            j++;
          }
        }.bind(this), 0);
      },

      /**
       * Called when a region is selected.
       */
      _regionSelected: function(e) {
        var regionName = e.detail.item.regionName;
        var venues = [];
        for(var key in this._globalRegions[regionName]) {
          venues.push(this._globalRegions[regionName][key]);
        }

        this._region = {
          name: regionName,
          venues: venues
        };

        this._disableVenueSelector = false;
      },

      /**
       * Called when an Venue is selected.
       */
      _venueSelected: function(e) {
        var newLocation = this._globalRegions[this._region.name][e.detail.item.venueId];
        if (newLocation !== this._venue) {
          this.dispatch('setVenue', newLocation);
          this.fire('venue-changed');
        }
      },

      /**
       * Select a region.
       *
       * @param {String} region
       */
      selectRegion: function(region) {
        this.$.regionSelector.contentElement.select(region);
      },

      /**
       * Select a venue.
       *
       * @param {String} venueId
       */
      selectVenue: function(venueId) {
        this.$.venueSelector.contentElement.select(venueId);
      },

      ready: function() {
        if (this._venue !== undefined) {
          this._venueChanged(this._venue);
        }
        this.playAnimation('entry');
      }
    });
  </script>
</dom-module>
