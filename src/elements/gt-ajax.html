<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../gt-element-common-behavior.html">

<dom-module id="gt-ajax">
  <template>
    <iron-ajax id="ajax"
      auto="[[auto]]"
      method="[[method]]"
      params="[[_getAjaxParams(method, useIdToken, idToken, params, cmsPreview)]]"
      body="[[_getAjaxBody(method, useIdToken, idToken, body)]]"
      url="[[getApiUrl(path)]]"
      handle-as="json"
      last-response="{{lastResponse}}"></iron-ajax>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'gt-ajax',

    behaviors: [
      GT.ElementCommonBehavior
    ],

    properties: {
      ironAjax: {
        type: Object,
        readOnly: true,
        value: function() {
          return this.$.ajax
        }
      },

      auto: {
        type: Boolean,
        value: false
      },

      method: {
        type: String,
        value: 'GET'
      },

      lastResponse: {
        type: Object,
        notify: true
      },

      path: {
        type: String,
        value: ''
      },

      params: {
        type: Object,
        value: {}
      },

      body: {
        type: Object,
        value: null,
        observer: '_onBodyChange'
      },

      useIdToken: {
        type: Boolean,
        value: false
      }
    },

    /**
     * Performs the AJAX request.
     *
     * @returns {!IronRequestElement}
     */
    generateRequest: function() {
      return this.$.ajax.generateRequest();
    },

    /**
     * Get the parameters to send in the ajax request
     */
    _getAjaxParams: function(method, useIdToken, idToken, userParams, cmsPreview) {
      var params = {};
      if (method.toUpperCase() === 'GET') {
        if (useIdToken || cmsPreview.using) {
          params['id-token'] = idToken;
        }
        if (cmsPreview.using) {
          params.previewStage = cmsPreview.stage;
          params.CMSPreview = 1;
        }
      }
      if (userParams) {
        Object.assign(params, userParams);
      }
      return params;
    },

    /**
     * Get the body to send in the ajax request
     */
    _getAjaxBody: function(method, useIdToken, idToken, userBody) {
      var body = {};
      if (useIdToken && method.toUpperCase() === 'POST') {
        body['id-token'] = idToken;
      }
      if (userBody) {
        Object.assign(body, userBody);
      }
      return body;
    },

    /**
     * Set the content-type of the body for the form based on what the body is.
     */
    _onBodyChange: function() {
      if (this.body) {
        this.$.ajax.contentType = 'application/x-www-form-urlencoded';
      } else {
        this.$.ajax.contentType = null;
      }
    }
  });
</script>
