<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="../imports/gt.html">
<script src="../node_modules/redux/dist/redux.js"></script>

<script>

  /**
   * Get the id-token from the a cookie.
   *
   * @returns {String}
   */
  var getIDTokenCookie = function() {
    var name = 'id-token=';
    var ca = decodeURIComponent(document.cookie).split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') {
          c = c.substring(1, c.length);
        }
        if (c.indexOf(name) === 0) {
          return c.substring(name.length, c.length);
        }
    }
    return null;
  };

  /**
   * Save the id-token into a cookie.
   *
   * @param {String} value - The id token
   */
  var setIDTokenCookie = function(value) {
    if (value === null || value === undefined || value === '') {
      return;
    }
    document.cookie = 'id-token=' + value + ';path=/';
  };

  /**
   * The initial state of the app.
   */
  var initialState = {
    dataPath: 'http://api.grandtraining.local/', // The path where this app should download data from. This path should alwasy end with a slash ('/').
    formHandlerPath: 'http://api.grandtraining.local/', // The path to form handlers. This path should alwasy end with a slash ('/').

    idToken: getIDTokenCookie(),

    config: undefined,
    venue: undefined,

    shellLoading: true,
    pageLoading: true,
    shellError: false,
    pageError: false,

    signedInUser: null
  };

  /**
   * Update the state of the application based on the current state and the action just performed.
   */
  var reducer = function(state, action) {
    if (!state) {
      return initialState;
    }

    switch (action.type) {
      case 'INIT':
        var config = Object.assign({}, action.config);
        var idToken = config['id-token'];
        if (idToken === '') {
          idToken = null;
        }
        delete config['id-token'];
        setIDTokenCookie(idToken);
        return Object.assign({}, state, {
          config: config,
          idToken: idToken
        });

      case 'SET_ID_TOKEN':
        setIDTokenCookie(action.idToken);
        return Object.assign({}, state, {
          idToken: action.idToken
        });

      case 'SET_VENUE':
        // if venue didn't change, don't update the value
        if (JSON.stringify(state.venue) === JSON.stringify(action.venue)) {
          return state;
        }
        return Object.assign({}, state, {
          venue: Object.assign({}, action.venue)
        });

      case 'SET_PAGE_LOADING':
        return Object.assign({}, state, {
          pageLoading: action.loading
        });

      case 'SET_PAGE_ERROR':
        return Object.assign({}, state, {
          pageError: action.error
        });

      case 'SET_SHELL_LOADING':
        return Object.assign({}, state, {
          shellLoading: action.loading
        });

      case 'SET_SHELL_ERROR':
        return Object.assign({}, state, {
          shellError: action.error
        });

      case 'SIGN_IN':
        return Object.assign({}, state, {
          signedInUser: Object.assign({}, action.user)
        });

      case 'SIGN_OUT':
        return Object.assign({}, state, {
          signedInUser: null
        });
    }
  };

  // create the redux store
  var store = Redux.createStore(reducer);

  // create the Behavior for use in elements
  GT.ReduxBehavior = PolymerRedux(store);
</script>
