<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="../imports/gt.html">
<script src="../node_modules/redux/dist/redux.js"></script>

<script>

  // How long until the signed in cookie expires
  var signedInExpiryTime = 14 * 24 * 60 * 60 * 1000;  // 14 days

  /**
   * Get a query string parameter.
   *
   * @param {String} name - the name of the parameter to get
   * @param {String} [url]=window.location.href - the url to get to parameter from
   * @returns {String}
   */
  var getQueryParameter = function(name, url) {
    if (!url) {
      url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    var results = regex.exec(url);
    if (!results) {
      return null;
    }
    if (!results[2]) {
      return '';
    }
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  };

  /**
   * Get a cookie by value.
   *
   * @param {String} name
   * @returns {String}
   */
  var getCookie = function(name) {
    var nameEq = name + '=';
    var ca = decodeURIComponent(document.cookie).split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') {
          c = c.substring(1, c.length);
        }
        if (c.indexOf(nameEq) === 0) {
          return c.substring(nameEq.length, c.length);
        }
    }
    return null;
  };

  /**
   * Get the id-token from the cookie.
   *
   * @returns {String}
   */
  var getIDTokenCookie = function() {
    return getCookie('id-token');
  };

  /**
   * Get remember-me from the cookie.
   *
   * @returns {Boolean}
   */
  var getRememberMeCookie = function() {
    return !!getCookie('remember-me');
  };

  /**
   * Save the id-token into a cookie.
   *
   * @param {String} value - The id token
   * @param {Boolean} [rememberMe=false] - if true, remember the current user and auto log them in
   */
  var setIDTokenCookie = function(value, rememberMe) {
    if (value === null || value === undefined || value === '') {
      return;
    }

    var tokenCookieString = 'id-token=' + value + ';path=/';

    if (rememberMe && signedInExpiryTime > 0) {
      var d = new Date();
      d.setTime(d.getTime() + signedInExpiryTime);
      var expiresString = d.toUTCString();

      tokenCookieString += ';expires=' + expiresString;
    }

    document.cookie = tokenCookieString;
    if (rememberMe) {
      document.cookie = 'remember-me=true;path=/;expires=' + expiresString;
    }
  };

  /**
   * Delete the id-token cookie.
   */
  var unsetIDTokenCookie = function() {
    document.cookie = 'id-token=;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT';
    document.cookie = 'remember-me=;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT';
  };

  /**
   * Load the id token.
   *
   * @returns {String}
   */
  var loadIDToken = function() {
    var param = getQueryParameter('id-token');
    if (param) {
      setIDTokenCookie(param, false);
      return param;
    } else {
      return getIDTokenCookie();
    }
  };

  var idToken = loadIDToken();

  // figer out if this is a cms preview request
  var usingCMSPreview = getQueryParameter('CMSPreview') && idToken;
  var cmsPreviewStage = undefined;
  if (usingCMSPreview) {
    cmsPreviewStage = getQueryParameter('stage');
  }

  /**
   * The initial state of the app.
   */
  var initialState = {
    apiPath: 'http://api.grandtraining.local/', // The path to the api this app will use to download and send data. This path should alwasy end with a slash ('/').

    idToken: idToken,

    cmsPreview: {
      using: usingCMSPreview,
      stage: cmsPreviewStage
    },

    config: undefined,
    venue: undefined,

    shellLoading: true,
    pageLoading: true,
    shellError: false,
    pageError: false,

    signedInUser: null,
    signinBackUrl: null,
    rememberMe: getRememberMeCookie()
  };

  /**
   * Update the state of the application based on the current state and the action just performed.
   */
  var reducer = function(state, action) {
    if (!state) {
      return initialState;
    }

    switch (action.type) {
      case 'INIT':
        return Object.assign({}, state, {
          config: Object.assign({}, action.config)
        });

      case 'SET_ID_TOKEN':
        setIDTokenCookie(action.idToken, state.rememberMe);
        return Object.assign({}, state, {
          idToken: action.idToken
        });

      case 'SET_VENUE':
        // if venue didn't change, don't update the value
        if (JSON.stringify(state.venue) === JSON.stringify(action.venue)) {
          return state;
        }
        return Object.assign({}, state, {
          venue: Object.assign({}, action.venue)
        });

      case 'SET_PAGE_LOADING':
        return Object.assign({}, state, {
          pageLoading: action.loading
        });

      case 'SET_PAGE_ERROR':
        return Object.assign({}, state, {
          pageError: action.error
        });

      case 'SET_SHELL_LOADING':
        return Object.assign({}, state, {
          shellLoading: action.loading
        });

      case 'SET_SHELL_ERROR':
        return Object.assign({}, state, {
          shellError: action.error
        });

      case 'SIGN_IN':
        setIDTokenCookie(action.newIdToken, action.rememberMe);
        return Object.assign({}, state, {
          signedInUser: Object.assign({}, action.user),
          idToken: action.newIdToken,
          rememberMe: action.rememberMe
        });

      case 'SIGN_OUT':
        unsetIDTokenCookie();
        if (GT.app.getPageElement().requiresLogin) {
          setTimeout(function() {
            GT.app.signinPrompt(window.location.href);
          }, 0);
        }
        return Object.assign({}, state, {
          signedInUser: null
        });

      case 'SET_SIGNIN_BACK_URL':
        return Object.assign({}, state, {
          signinBackUrl: action.url
        });

      case 'CLEAR_SIGNIN_BACK_URL':
        return Object.assign({}, state, {
          signinBackUrl: null
        });
    }
  };

  // create the redux store
  var store = Redux.createStore(reducer);

  // create the Behavior for use in elements
  GT.ReduxBehavior = PolymerRedux(store);
</script>
