<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="../imports/gt.html">
<script src="../node_modules/redux/dist/redux.js"></script>

<script>

  /**
   * Get a query string parameter.
   *
   * @param {String} name - the name of the parameter to get
   * @param {String} [url]=window.location.href - the url to get to parameter from
   * @returns {String}
   */
  var getQueryParameter = function(name, url) {
    if (!url) {
      url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    var results = regex.exec(url);
    if (!results) {
      return null;
    }
    if (!results[2]) {
      return '';
    }
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  };

  /**
   * Get the id-token from the a cookie.
   *
   * @returns {String}
   */
  var getIDTokenCookie = function() {
    var name = 'id-token=';
    var ca = decodeURIComponent(document.cookie).split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') {
          c = c.substring(1, c.length);
        }
        if (c.indexOf(name) === 0) {
          return c.substring(name.length, c.length);
        }
    }
    return null;
  };

  /**
   * Save the id-token into a cookie.
   *
   * @param {String} value - The id token
   */
  var setIDTokenCookie = function(value) {
    if (value === null || value === undefined || value === '') {
      return;
    }
    document.cookie = 'id-token=' + value + ';path=/';
  };

  /**
   * Load the id token.
   *
   * @returns {String}
   */
  var loadIDToken = function() {
    var param = getQueryParameter('id-token');
    if (param) {
      setIDTokenCookie(param);
      return param;
    } else {
      return getIDTokenCookie();
    }
  };

  var idToken = loadIDToken();

  // figer out if this is a cms preview request
  var usingCMSPreview = getQueryParameter('CMSPreview') && idToken;
  var cmsPreviewStage = undefined;
  if (usingCMSPreview) {
    cmsPreviewStage = getQueryParameter('stage');
  }

  /**
   * The initial state of the app.
   */
  var initialState = {
    apiPath: 'http://api.grandtraining.local/', // The path to the api this app will use to download and send data. This path should alwasy end with a slash ('/').

    idToken: idToken,

    cmsPreview: {
      using: usingCMSPreview,
      stage: cmsPreviewStage
    },

    config: undefined,
    venue: undefined,

    shellLoading: true,
    pageLoading: true,
    shellError: false,
    pageError: false,

    signedInUser: null
  };

  /**
   * Update the state of the application based on the current state and the action just performed.
   */
  var reducer = function(state, action) {
    if (!state) {
      return initialState;
    }

    switch (action.type) {
      case 'INIT':
        var config = Object.assign({}, action.config);
        var idToken = config['id-token'];
        if (idToken === '') {
          idToken = null;
        }
        delete config['id-token'];
        setIDTokenCookie(idToken);
        return Object.assign({}, state, {
          config: config,
          idToken: idToken
        });

      case 'SET_ID_TOKEN':
        setIDTokenCookie(action.idToken);
        return Object.assign({}, state, {
          idToken: action.idToken
        });

      case 'SET_VENUE':
        // if venue didn't change, don't update the value
        if (JSON.stringify(state.venue) === JSON.stringify(action.venue)) {
          return state;
        }
        return Object.assign({}, state, {
          venue: Object.assign({}, action.venue)
        });

      case 'SET_PAGE_LOADING':
        return Object.assign({}, state, {
          pageLoading: action.loading
        });

      case 'SET_PAGE_ERROR':
        return Object.assign({}, state, {
          pageError: action.error
        });

      case 'SET_SHELL_LOADING':
        return Object.assign({}, state, {
          shellLoading: action.loading
        });

      case 'SET_SHELL_ERROR':
        return Object.assign({}, state, {
          shellError: action.error
        });

      case 'SIGN_IN':
        setIDTokenCookie(action.newIdToken);
        return Object.assign({}, state, {
          signedInUser: Object.assign({}, action.user),
          idToken: action.newIdToken
        });

      case 'SIGN_OUT':
        return Object.assign({}, state, {
          signedInUser: null
        });
    }
  };

  // create the redux store
  var store = Redux.createStore(reducer);

  // create the Behavior for use in elements
  GT.ReduxBehavior = PolymerRedux(store);
</script>
