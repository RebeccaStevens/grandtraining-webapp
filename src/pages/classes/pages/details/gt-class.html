<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../../../styles/gt-styles.html">
<link rel="import" href="../../../../gt-element-common-behavior.html">

<dom-module id="gt-class">
  <template>
    <style include="gt-styles paper-material-shared-styles">
      :host {
        display: block;
      }
      #card {
        display: block;
        --paper-card-header-text: {
          color: #88b6cd;
          font-size: 36px;
          line-height: 1.05;
          padding-bottom: 4px;
          font-weight: bold;
          text-shadow:  3px  3px 0 #000,
                       -1px -1px 0 #000,
                        1px -1px 0 #000,
                       -1px  1px 0 #000,
                        1px  1px 0 #000;
        };
        --paper-card-header-image: {
          padding-bottom: 20%;
          height: 0;
        }
      }
      #card .card-content {
        padding-top: 0.75em;
      }
      .details {
        font-size: 10pt;
        margin-bottom: 0.5em;
        background-color: #f0f0f0;
        border-radius: 0.5em;
        padding: 0.5em;
        overflow: auto;
        float: left;
        margin: 0 0.8em 0.8em 0;
      }
      #level {

      }
      #age-range {

      }
      #bookings h3 {
        margin-bottom: 0.25em;
      }
      #no-bookings-available h3 {
        margin-bottom: 0;
      }
      #no-bookings-available p:first-of-type {
        margin-top: 0.33em;
      }
      .excluded-dates {
        font-size: 8pt;
      }
      .table {
        line-height: normal;
      }
      .table .row {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        @apply(--layout-wrap);
      }
      .table .row .cell {
        @apply(--layout-flex);
      }
      .table .header .row .cell {
        text-align: center;
        font-weight: bold;
        padding: 0.5em 0;
      }
      #dates {
        border-radius: 0.5em;
        overflow: hidden;
      }
      #dates .header .row {
        background-color: #cee6f2;
      }
      #dates .body .row {
        background-color: #f0f0f0;
      }
      #dates .body .row:nth-child(2n) {
        background-color: #e8e8e8;
      }
      #dates .body .row[disabled] {
        color: var(--app-text-disabled-color);
      }
      #dates .cell.duration {
        min-width: 60px;
      }
      #dates .cell.cost {
        min-width: 60px;
      }
      #dates .cell.booknow {
        max-width: 96px;
        min-width: 96px;
      }
      #dates .header .cell.booknow {
        display: none;
      }
      #dates .body .row {
        padding: 0.625em 0.125em 0.125em 0.125em;
      }
      #dates .body .cell.date {
        min-width: 100%;
        text-align: center;
      }
      #dates .body .cell.date .wrap {
        display: inline-block;
        text-align: center;
      }
      #dates .body .cell.date .date-range {
        font-weight: bold;
      }
      #dates .body .cell.duration {
        text-align: center;
      }
      #dates .body .cell.cost {
        text-align: center;
      }
      #dates .body .cell.booknow paper-button {
        font-size: 14px;
        width: calc(100% - 0.5em);
        margin: 0.25em;
      }
      #dates .body .cell.booknow paper-button[disabled] {
        color: var(--app-text-disabled-color);
      }
      @media (min-width: 640px) {
        #dates .cell.date {
          @apply(--layout-flex-3);
        }
        #dates .body .row {
          padding: 0.125em;
        }
        #dates .body .cell.date {
          text-align: left;
          padding-left: 0.75em;
          min-width: auto;
        }
        #dates .body .cell.date .date-range {
          font-weight: normal;
        }
        #dates .header .cell.booknow {
          display: block;
        }
      }
    </style>

    <paper-card id="card" heading="[[title]]" elevation="2" image="[[image.src]]" placeholder-image="[[image.placeholder]]" sizing-image="cover" preload-image fade-image>
      <div class="card-content">
        <paper-material class="details" id="level" title$="[[_getLevelTitle(level)]]">Class Level: [[level]]</paper-material>
        <paper-material class="details" id="age-range" title$="Recommended for ages: [[minAge]]-[[maxAge]]">Ages: [[minAge]] &ndash; [[maxAge]]</paper-material>
        <span class="clear"></span>
        <div id="description">
          <content></content>
        </div>
        <div id="bookings" hidden$="[[!doesArrayHaveValues(dates)]]">
          <h3>Book Now</h3>
          <paper-material id="dates" class="table">
            <div class="header">
              <div class="row">
                <div class="cell date">Date</div>
                <div class="cell duration">Duration</div>
                <div class="cell cost">Cost</div>
                <div class="cell booknow"></div>
              </div>
            </div>
            <div class="body">
              <template is="dom-repeat" items="[[dates]]" as="date">
                <div class="row" disabled$="[[!_isAvailable(date.availability)]]">
                  <div class="cell date">
                    <div class="wrap">
                      <span class="date-range">[[_getDisplayDateRange(date.start-date, date.end-date)]]</span><br>
                      <span class="excluded-dates" hidden$="[[!doesArrayHaveValues(date.excludes)]]">[[_getDisplayExcludedDates(date.excludes)]]</span>
                    </div>
                  </div>
                  <div class="cell duration">[[_getDisplayDuration(date.start-date, date.end-date, date.excludes)]]</div>
                  <div class="cell cost">[[_getDisplayCurrency(date.cost)]]</div>
                  <div class="cell booknow">
                    <template is="dom-if" if="[[_isAvailable(date.availability)]]">
                      <a name="classes" href$="[[_getBookNowLink(date.id)]]" tabindex="-1"><paper-button raised>[[_getBookNowText(date.availability)]]</paper-button></a>
                    </template>
                    <template is="dom-if" if="[[!_isAvailable(date.availability)]]">
                      <paper-button raised disabled>[[_getBookNowText(date.availability)]]</paper-button>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </paper-material>
        </div>
        <div id="no-bookings-available" hidden$="[[doesArrayHaveValues(dates)]]">
          <h3>This class is currently unavailable to book.</h3>
          <p>Please check back later or <a href$="[[app.data.links.contactus]]">contact us</a> for more information.</p>
        </div>
      </div>
    </paper-card>
  </template>

  <script>
    Polymer({
      is: 'gt-class',

      behaviors: [
        GT.ElementCommonBehavior
      ],

      properties: {

        title: {
          type: String,
          observer: '_titleChanged'
        },

        level: {
          type: String
        },

        image: {
          type: Object,
          value: function() {
            return {
              src: undefined,
              placeholder: undefined
            };
          }
        },

        minAge: {
          type: Number,
          value: 5
        },

        maxAge: {
          type: Number,
          value: 17
        },

        dates: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * A look up table that can be used to get day information from a day index.
         */
        _dayLookUp: {
          type: Array,
          // this is a static value, hence why it's not returned in a function.
          value: [
            { short: 'Sun', long: 'Sunday' },
            { short: 'Mon', long: 'Monday' },
            { short: 'Tue', long: 'Tuesday' },
            { short: 'Wed', long: 'Wednesday' },
            { short: 'Thu', long: 'Thursday' },
            { short: 'Fri', long: 'Friday' },
            { short: 'Sat', long: 'Saturday' }
          ]
        },

        /**
         * A look up table that can be used to get month information from a month index.
         */
        _monthLookUp: {
          type: Array,
          // this is a static value, hence why it's not returned in a function.
          value: [
            { short: 'Jan', long: 'January' },
            { short: 'Feb', long: 'Febuary' },
            { short: 'Mar', long: 'March' },
            { short: 'Apr', long: 'April' },
            { short: 'May', long: 'May' },
            { short: 'Jun', long: 'June' },
            { short: 'Jul', long: 'July' },
            { short: 'Aug', long: 'August' },
            { short: 'Sep', long: 'September' },
            { short: 'Oct', long: 'October' },
            { short: 'Nov', long: 'November' },
            { short: 'Dec', long: 'December' }
          ]
        }
      },

      /**
       * Format a date range of a class booking.
       *
       * @param {String} startDate
       * @param {String} endDate
       * @returns {String}
       */
      _getDisplayDateRange: function(startDate, endDate) {
        var start = new Date(startDate);
        var end = new Date(endDate);
        var dateString = '';

        if (start.getTime() !== end.getTime()) {
          dateString += this._dayLookUp[start.getDay()].short;
          dateString += ' ' + this._getOrdinalOfNumber(start.getDate()).super;
          if (start.getMonth() !== end.getMonth()) {
            dateString += ' ' + this._monthLookUp[start.getMonth()].short;
          }
          if (start.getFullYear() !== end.getFullYear()) {
            dateString += ' ' + start.getFullYear();
          }

          dateString += ' - ';
        }

        dateString += this._dayLookUp[end.getDay()].short;
        dateString += ' ' + this._getOrdinalOfNumber(end.getDate()).super;
        dateString += ' ' + this._monthLookUp[end.getMonth()].short;
        dateString += ' ' + end.getFullYear();

        return dateString;
      },

      _getDisplayExcludedDates: function(excludes) {
        var excludesString = '(Excludes: ';

        for (var i in excludes) {
          var date = new Date(excludes[i]);
          excludesString += this._getOrdinalOfNumber(date.getDate()).super + ' ' + this._monthLookUp[date.getMonth()].short;
          if (i + 2 < excludes.length) {
            excludesString += ', ';
          }
          else if (i + 1 < excludes.length) {
            excludesString += ' and ';
          }
        }

        excludesString += ')';

        return excludesString;
      },

      /**
       * Format the duration of a class booking.
       *
       * @param {String} startDate
       * @param {String} endDate
       * @returns {String}
       */
      _getDisplayDuration: function(startDate, endDate, excludes) {
        var start = new Date(startDate);
        var end = new Date(endDate);

        var timeDiff = Math.abs(end.getTime() - start.getTime());
        var days = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;

        days -= excludes.length;

        if (days === 1) {
          return days + ' Day';
        }
        return days + ' Days';
      },

      /**
       * Format the cost of a class booking.
       *
       * @param {Number} amount
       * @returns {String}
       */
      _getDisplayCurrency: function(amount) {
        return '$' + amount.toFixed(2);
      },

      /**
       * Get the text for the book now button based on the class availability.
       *
       * @param {!String} availability
       */
      _getBookNowText: function(availability) {
        switch (availability) {
          case 'available':
            return 'Book Now';
          case 'full':
            return 'Full';
          case 'canceled':
            return 'Canceled';
        }
      },

      /**
       * Returns true if availability is available.
       *
       * @param {!String} availability
       */
      _isAvailable: function(availability) {
        return availability === 'available';
      },

      /**
       * Get the title for the class level.
       *
       * @param {String} level
       * @returns {String}
       */
      _getLevelTitle: function(level) {
        var lvl = level.toLowerCase();
        var firstChar = lvl.charAt(0);

        // simple check to see if 'a' or 'an' prefix should be used
        if (firstChar === 'a' || firstChar === 'e' || firstChar === 'i' || firstChar === 'o' || firstChar === 'u') {
          return 'This is an ' + lvl + ' class';
        }
        return 'This is a ' + lvl + ' class';
      },

      /**
       * Get the ordinal of a number.
       *
       * @param {Number} number
       * @returns {Object}
       */
      _getOrdinalOfNumber: function(number) {
        var nOrds=['th', 'st', 'nd', 'rd'];
        var sOrds=['\u1D57\u02B0', '\u02E2\u1D57', '\u207F\u1D48', '\u02B3\u1D48'];
        var v = number % 100;

        var i = ((v - 20) % 10);
        if (i < 0 || i >= 4) {
         if (v >= 0 && v <= 3) {
            i = v;
          } else {
            i = 0;
          }
        }

        return {
          normal: number + nOrds[i],
          super:  number + sOrds[i]
        };
      },

      /**
       * Called when `title` changes.
       */
      _titleChanged: function(title) {
        this.async(function() {
          this._updateTitleSize();
        }, 0);
      },

      /**
       * Update the font size of the title.
       */
      _updateTitleSize: function() {
        var container = Polymer.dom(this.$.card.root).querySelector('.title-text');
        container.style.fontSize = '';
        var computedStyle = getComputedStyle(container);
        var textWidth = GT.app.getTextWidth(this.title, computedStyle.font);
        var toolbarTextWidth = container.clientWidth - 32;
        var toolbarTextHeight = Polymer.dom(this.$.card.root).querySelector('.header').clientHeight - 20;

        var fontSize = Number.parseInt(computedStyle.fontSize, 10);
        var adjustedFontSize = fontSize * toolbarTextWidth / textWidth;
        var minFontSize = 18;
        var maxFontSize = toolbarTextHeight * 0.55;

        // scale the text to fit in the toolbar.
        if (textWidth > toolbarTextWidth || fontSize > maxFontSize || fontSize < minFontSize) {
          if (adjustedFontSize > maxFontSize) {
            adjustedFontSize = maxFontSize;
          }
          if (adjustedFontSize < minFontSize) {
            adjustedFontSize = minFontSize;
          }
          container.style.fontSize = adjustedFontSize + 'px';
        }
      },

      /**
       * Get the link to follow to book this course.
       */
      _getBookNowLink: function(id) {
        return this.app.data.links.bookclass + '/' + id;
      },

      ready: function() {
        window.addEventListener('resize', function() {
          this.debounce('gt-class-resize', function() {
            this._updateTitleSize();
          }, 100);
        }.bind(this));
      }
    });
  </script>
</dom-module>
