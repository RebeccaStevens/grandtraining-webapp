<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../../../../../styles/gt-styles.html">

<dom-module id="gt-class">
  <template>
    <style include="gt-styles paper-material-shared-styles">
      :host {
        display: block;
      }
      #card {
        display: block;
      }
      #card .card-content {
        padding-top: 0.2em;
      }
      .details {
        font-size: 10pt;
        margin-bottom: 0.5em;
        background-color: #f0f0f0;
        border-radius: 0.5em;
        padding: 0.5em;
        overflow: auto;
        float: left;
        margin: 0 0.8em 0.8em 0;
      }
      #level {

      }
      #age-range {

      }
      #bookings h3 {
        margin-bottom: 0.25em;
      }
      #no-bookings-available h3 {
        margin-bottom: 0;
      }
      #no-bookings-available p:first-of-type {
        margin-top: 0.33em;
      }
      #dates {
        border-radius: 0.5em;
        overflow: hidden;
      }
      #dates table {
        width: calc(100% + 1px);
        border-collapse: collapse;
        border-spacing: 0;
      }
      #dates table thead tr {
        background-color: #f0f0f0;
      }
      #dates table thead tr th {
        padding: 0.25em;
      }
      #dates table tr td {
        padding: 0.25em;
      }
      #dates table tbody tr:nth-child(2n) {
        background-color: #f0f0f0;
      }
      #dates table tbody tr:nth-child(2n+1) {
        background-color: #e0e0e0;
      }
      #dates table thead .date {
        text-align: center;
      }
      #dates table thead .duration {
        text-align: center;
      }
      #dates table thead .cost {
        text-align: center;
      }
      #dates table thead .booknow {

      }
      #dates table tbody .date {
        text-align: left;
        padding-left: 2%;
      }
      #dates table tbody .duration {
        text-align: center;
      }
      #dates table tbody .cost {
        text-align: center;
      }
      #dates table tbody .booknow {
        width: 90px;
      }
      #dates table tbody .booknow paper-button {
        font-size: 14px;
        width: calc(100% - 0.3em);
        margin: 0.15em;
      }
    </style>

    <paper-card id="card" heading="[[title]]" elevation="2">
      <div class="card-content">
        <paper-material class="details" id="level" title="[[_getLevelTitle(level)]]">Class Level: [[level]]</paper-material>
        <paper-material class="details" id="age-range" title="Recommended for ages: [[minAge]]-[[maxAge]]">Ages: [[minAge]] &ndash; [[maxAge]]</paper-material>
        <span class="clear"></span>
        <div id="description">
          <content></content>
        </div>
        <div id="bookings" hidden$="[[!_arrayHasValues(dates)]]">
          <h3>Book Now</h3>
          <paper-material id="dates">
            <table>
              <thead>
                <tr>
                  <th class="date">Date</th>
                  <th class="duration">Duration</th>
                  <th class="cost">Cost</th>
                  <th class="booknow"></th>
                </tr>
              </thead>
              <tbody>
                <template is="dom-repeat" items="[[dates]]" as="date">
                  <tr>
                    <td class="date">
                      [[_getDisplayDateRange(date.start-date, date.end-date)]]<br>
                      <span class="excluded-dates" hidden$="[[!_arrayHasValues(date.excludes)]]">[[_getDisplayExcludedDates(date.excludes)]]</span>
                    </td>
                    <td class="duration">[[_getDisplayDuration(date.start-date, date.end-date, date.excludes)]]</td>
                    <td class="cost">[[_getDisplayCurrency(date.cost)]]</td>
                    <td class="booknow"><a name="classes" href$="#" tabindex="-1"><paper-button raised>Book Now</paper-button></a></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </paper-material>
        </div>
        <div id="no-bookings-available" hidden$="[[_arrayHasValues(dates)]]">
          <h3>This class is currently unavailable to book.</h3>
          <p>Please check back later or contact us for more information.</p>
        </div>
      </div>
    </paper-card>
  </template>

  <script>
    Polymer({
      is: 'gt-class',

      properties: {

        title: {
          type: String
        },

        level: {
          type: String
        },

        minAge: {
          type: Number,
          value: 5
        },

        maxAge: {
          type: Number,
          value: 17
        },

        dates: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * A look up table that can be used to get day information from a day index.
         */
        _dayLookUp: {
          type: Array,
          // this is a static value, hence why it's not returned in a function.
          value: [
            { short: 'Sun', long: 'Sunday' },
            { short: 'Mon', long: 'Monday' },
            { short: 'Tue', long: 'Tuesday' },
            { short: 'Wed', long: 'Wednesday' },
            { short: 'Thu', long: 'Thursday' },
            { short: 'Fri', long: 'Friday' },
            { short: 'Sat', long: 'Saturday' }
          ]
        },

        /**
         * A look up table that can be used to get month information from a month index.
         */
        _monthLookUp: {
          type: Array,
          // this is a static value, hence why it's not returned in a function.
          value: [
            { short: 'Jan', long: 'January' },
            { short: 'Feb', long: 'Febuary' },
            { short: 'Mar', long: 'March' },
            { short: 'Apr', long: 'April' },
            { short: 'May', long: 'May' },
            { short: 'Jun', long: 'June' },
            { short: 'Jul', long: 'July' },
            { short: 'Aug', long: 'August' },
            { short: 'Sep', long: 'September' },
            { short: 'Oct', long: 'October' },
            { short: 'Nov', long: 'November' },
            { short: 'Dec', long: 'December' }
          ]
        }
      },

      /**
       * Format a date range of a class booking.
       *
       * @param {String} startDate
       * @param {String} endDate
       * @returns {String}
       */
      _getDisplayDateRange: function(startDate, endDate) {
        var start = new Date(startDate);
        var end = new Date(endDate);
        var dateString = '';

        if (start.getTime() !== end.getTime()) {
          dateString += this._dayLookUp[start.getDay()].short;
          dateString += ' ' + this._getOrdinalOfNumber(start.getDate()).super;
          if (start.getMonth() !== end.getMonth()) {
            dateString += ' ' + this._monthLookUp[start.getMonth()].short;
          }
          if (start.getFullYear() !== end.getFullYear()) {
            dateString += ' ' + start.getFullYear();
          }

          dateString += ' - ';
        }

        dateString += this._dayLookUp[end.getDay()].short;
        dateString += ' ' + this._getOrdinalOfNumber(end.getDate()).super;
        dateString += ' ' + this._monthLookUp[end.getMonth()].short;
        dateString += ' ' + end.getFullYear();

        return dateString;
      },

      _getDisplayExcludedDates: function(excludes) {
        var excludesString = '(Excludes: ';

        for (var i in excludes) {
          var date = new Date(excludes[i]);
          excludesString += this._getOrdinalOfNumber(date.getDate()).super + ' ' + this._monthLookUp[date.getMonth()].short;
          if (i + 2 < excludes.length) {
            excludesString += ', ';
          }
          else if (i + 1 < excludes.length) {
            excludesString += ' and ';
          }
        }

        excludesString += ')';

        return excludesString;
      },

      /**
       * Format the duration of a class booking.
       *
       * @param {String} startDate
       * @param {String} endDate
       * @returns {String}
       */
      _getDisplayDuration: function(startDate, endDate, excludes) {
        var start = new Date(startDate);
        var end = new Date(endDate);

        var timeDiff = Math.abs(end.getTime() - start.getTime());
        var days = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;

        days -= excludes.length;

        if (days === 1) {
          return days + ' Day';
        }
        return days + ' Days';
      },

      /**
       * Format the cost of a class booking.
       *
       * @param {Number} amount
       * @returns {String}
       */
      _getDisplayCurrency: function(amount) {
        return '$' + amount.toFixed(2);
      },

      /**
       * Returns if true if the array has any values.
       *
       * @param {Array} arr
       * @returns {Boolean}
       */
      _arrayHasValues: function(arr) {
        return dates.arr > 0;
      },

      _getLevelTitle: function(level) {
        var lvl = level.toLowerCase();
        var firstChar = lvl.charAt(0);

        // simple check to see if 'a' or 'an' prefix should be used
        if (firstChar === 'a' || firstChar === 'e' || firstChar === 'i' || firstChar === 'o' || firstChar === 'u') {
          return 'This is an ' + lvl + ' class';
        }
        return 'This is a ' + lvl + ' class';
      },

      /**
       * Get the ordinal of a number.
       *
       * @param {Number} number
       * @returns {Object}
       */
      _getOrdinalOfNumber: function(number) {
        var nOrds=['th', 'st', 'nd', 'rd'];
        var sOrds=['\u1D57\u02B0', '\u02E2\u1D57', '\u207F\u1D48', '\u02B3\u1D48'];
        var v = number % 100;

        var i = ((v - 20) % 10);
        if (i < 0 || i >= 4) {
         if (v >= 0 && v <= 3) {
            i = v;
          } else {
            i = 0;
          }
        }

        return {
          normal: number + nOrds[i],
          super:  number + sOrds[i]
        };
      }
    });
  </script>
</dom-module>
