<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/neon-animation/animations/slide-up-animation.html">
<link rel="import" href="../../../../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../../../../bower_components/neon-animation/animations/slide-from-top-animation.html">
<link rel="import" href="../../../../../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="../../../../../styles/gt-styles.html">
<link rel="import" href="../../../../gt-element-common-behavior.html">

<dom-module id="gt-location-selector">
  <template>
    <style include="gt-styles">
      :host {
        display: block;
        visibility: hidden;
      }
      :host([shown]) {
        visibility: visible;
      }
      #card {
        width: 100%;
        --paper-card-content: {
          padding-top: 0;
        };
      }
      #card .card-content {
        @apply(--layout-horizontal);
      }
      #card .card-content paper-dropdown-menu {
        margin: 0 0.5em;
        @apply(--layout-flex);
      }
      #card .card-content paper-dropdown-menu:first-child {
        margin-left: 0;
      }
      #card .card-content paper-dropdown-menu:last-child {
        margin-right: 0;
      }
    </style>

    <paper-card id="card" heading="Your Location">
      <div class="card-content">
        <paper-dropdown-menu id="citySelector" label="City">
          <paper-listbox class="dropdown-content" on-iron-select="_citySelected">
            <template is="dom-repeat" items="[[_cities]]" as="city">
              <paper-item city-name="[[city.name]]">[[city.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu id="locationSelector" label="Area" disabled$="[[_disableLocationSelector]]">
          <paper-listbox class="dropdown-content" on-iron-select="_locationSelected">
            <template is="dom-repeat" items="[[_locations]]" as="location">
              <paper-item location-id="[[location.id]]">[[location.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
    </paper-card>
  </template>

  <script>
    Polymer({
      is: 'gt-location-selector',

      behaviors: [
        GT.ElementCommonBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {

        /**
         * The gloabel cities object
         */
        globalCities: {
          type: Object,
          observer: '_gloabelCitiesChanged'
        },

        /**
         * The selected location.
         */
        location: {
          type: Object,
          notify: true,
          observer: '_locationChanged'
        },

        /**
         * The selected city.
         */
        _city: {
          type: Object,
          notify: true,
          observer: '_cityChanged'
        },

        /**
         * A list of the cities the user can choose from.
         */
        _cities: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * A list of the cities the user can choose from.
         */
        _locations: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * States whether or not he LocationSelector should be disabled.
         */
        _disableLocationSelector: {
          type: Boolean,
          value: true
        },

        /**
         * If true, the next time `_city` is changed, `$.locationSelector` will not deselect its current item.
         */
        _preventNextLocationSelectorDeselect: {
          type: Boolean,
          value: false
        },

        /**
         * If true, the next time `location` is changed, `_locationChanged` won't do anything.
         */
        _preventNextLocationChangedEvent: {
          type: Boolean,
          value: false
        },

        /**
         * States whether or not this element is shown.
         */
        shown: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * True if in the process of hidden the element.
         */
        _hidding: {
          type: Boolean,
          value: false
        },

        /**
         * The animations this element has.
         */
        animationConfig: {
          value: function() {
            return {
              entry: {
                name: 'slide-from-top-animation',
                node: this,
                timing: {
                  delay: 0,
                  duration: 1000
                }
              },
              exit: [
                {
                  name: 'slide-up-animation',
                  node: this,
                  timing: {
                    delay: 0,
                    duration: 500
                  }
                },
                {
                  name: 'fade-out-animation',
                  node: this,
                  timing: {
                    delay: 0,
                    duration: 500
                  }
                }
              ]
            };
          }
        }
      },

      listeners: {
        'neon-animation-finish': '_onNeonAnimationFinish'
      },

      /**
       * Show this element.
       */
      show: function() {
        this.shown = true;
        this.cancelAnimation();
        this.playAnimation('entry');
      },

      /**
       * Hide this element.
       */
      hide: function() {
        this._hidding = true;
        this.cancelAnimation();
        this.playAnimation('exit');
      },

      /**
       * Called when an animation finishes playing.
       */
      _onNeonAnimationFinish: function() {
        if (this._hidding) {
          this._hidding = false;
          this.shown = false;
        }
      },

      /**
       * Called when `app.data.cities` changes.
       */
      _gloabelCitiesChanged: function(cities) {
        var cityArray = [];
        for (var key in cities) {
          var city = {
            name: key,
            locations: cities[key]
          };

          cityArray.push(city);
        }
        this.set('_cities', cityArray);
      },

      /**
       * Called when `_city` changes.
       */
      _cityChanged: function(city) {
        this._locations = city.locations;

        if (this._preventNextLocationSelectorDeselect) {
          this._preventNextLocationSelectorDeselect = false;
        }
        else {
          Polymer.dom(this.$.locationSelector).querySelector('paper-listbox').selected = -1;

          if (city.locations.length === 1) {
            this.async(function() {
              Polymer.dom(this.$.locationSelector).querySelector('paper-listbox').selected = 0;
            }, 0);
          }
        }
      },

      /**
       * Called when `location` changes.
       */
      _locationChanged: function(location) {
        // prevent this method from being called from stuff done in this element
        if (this._preventNextLocationChangedEvent) {
          this._preventNextLocationChangedEvent = false;
          return;
        }

        var cities = this._cities;

        if (cities.length === 0) {
          return;
        }

        var city;
        var i = 0;
        for (city in cities) {
          if (cities[city].name === location.city) {
            Polymer.dom(this.$.citySelector).querySelector('paper-listbox').selected = i;
            break;
          }
          i++;
        }

        var areas = cities[city].locations;
        var j = 0;
        for (var area in areas) {
          if (areas[area].id === location.id) {
            Polymer.dom(this.$.locationSelector).querySelector('paper-listbox').selected = j;
            break;
          }
          j++;
        }

        this._preventNextLocationSelectorDeselect = true;
      },

      /**
       * Called when a city is selected.
       */
      _citySelected: function(e) {
        var cityName = e.detail.item.cityName;
        var locations = [];
        for(var key in this.globalCities[cityName]) {
          locations.push(this.globalCities[cityName][key]);
        }

        this._city = {
          name: cityName,
          locations: locations
        };

        this._disableLocationSelector = false;
      },

      /**
       * Called when a location is selected.
       */
      _locationSelected: function(e) {
        this._preventNextLocationChangedEvent = true;
        this.location = this.globalCities[this._city.name][e.detail.item.locationId];
        this.fire('location-set');
      },

      ready: function() {
        if (this.location !== undefined) {
          this._locationChanged(this.location);
        }
      }
    });
  </script>
</dom-module>
