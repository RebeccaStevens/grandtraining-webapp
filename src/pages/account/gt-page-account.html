<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/paper-date-picker/paper-date-picker.html">

<link rel="import" href="../../../styles/gt-styles.html">
<link rel="import" href="../../../imports/gt.html">
<link rel="import" href="../../elements/gt-venue-selector.html">
<link rel="import" href="../../gt-element-common-behavior.html">
<link rel="import" href="../../elements/gt-dialog.html">
<link rel="import" href="../gt-page-behavior.html">

<dom-module id="gt-page-account">
  <template>
    <style include="gt-styles">
      :host {
        display: block;
        @apply(--layout-horizontal);
        @apply(--layout-start);
        @apply(--layout-center-justified);
      }
      form {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        max-width: 1140px;
        margin: 0.75em 0.25em 0 0.25em;
        width: calc(100% - 0.5em);
        box-sizing: border-box;
      }
      fieldset {
        border: none;
        margin: 0;
        padding: 0 4px;
      }
      #card {
        width: 100%;
      }
      #card .card-content {
        padding: 0 24px 16px 24px;
      }
      #submit-container {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        overflow: hidden;
      }
      #submit-container .messgae {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin-right: 16px;
      }
      #card h4 {
        margin-top: 1.25em;
        margin-bottom: 0;
      }
      #card h4:first-of-type {
        margin-top: 0.25em;
      }
      #regionSelector,
      #venueSelector {
        width: 100%;
      }
      .field-spacer {
        display: none;
      }
      vaadin-grid {
        height: auto;
        margin-top: 8px;
        --vaadin-grid-header-cell: {
          font-weight: bold;
        };
        --vaadin-grid-body-cell: {
          padding: 0 8px;
        };
      }
      vaadin-grid paper-input,
      vaadin-grid vaadin-combo-box,
      vaadin-grid vaadin-date-picker {
        --paper-input-container: {
          margin-top: 4px;
          padding: 0;
        };
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-input: {
          padding-right: 28px !important;
          margin-right: 0 !important;
        };
      }
      #add-child-btn {
        float: right;
        margin: 16px 0 0 0;
        height: 38px;
        border: 1px solid #dbdbdb;
        background: #f0f0f0;
        --paper-button-ink-color: #ffffff;
      }
      #add-child-btn[no-children] {
        margin: 0;
      }
      @media (min-width: 640px) {
        .field-spacer {
          display: inline-block;
          width: 12px;
        }
        #first-name,
        #last-name {
          width: calc(50% - 6px);
          display: inline-block;
        }
        #phone,
        #email {
          width: calc(50% - 6px);
          display: inline-block;
        }
        #regionSelector,
        #venueSelector {
          width: calc(50% - 6px);
          display: inline-block;
        }
      }
    </style>

    <!-- Layout -->
    <gt-venue-selector id="venue-selector" hidden regions="{{_regions}}" venues="{{_venues}}"></gt-venue-selector>

    <form is="iron-form"
      id="form"
      method="post"
      action="[[getApiUrl(appConfig.form-handlers.update-account-details)]]"
      on-iron-form-submit="_onFormSubmit"
      on-iron-form-error="_onFormError"
      on-iron-form-response="_onFormResponse">
      <paper-card id="card" heading="Account Details">
        <div class="card-content">
          <paper-material class="error-message" hidden$="[[!isDefined(_formErrorMessage)]]">[[_formErrorMessage]]</paper-material>

          <h4>Personal Details</h4>
          <fieldset>
            <paper-input id="first-name" class="field" name="FirstName" type="text" label="First Name" auto-validate required></paper-input><span class="field-spacer"
            ></span><paper-input id="last-name" class="field" name="Surname" type="text" label="Last Name" auto-validate required></paper-input>
            <paper-input id="phone" class="field" name="Phone" type="tel" label="Phone Number" auto-validate></paper-input><span class="field-spacer"
            ></span><paper-input id="email" class="field" name="Email" type="email" label="Email Address" auto-validate required></paper-input>
          </fieldset>

          <h4>Venue</h4>
          <fieldset>
            <paper-dropdown-menu id="regionSelector" label="Region">
              <paper-listbox class="dropdown-content" attr-for-selected="regionName" attr-for-item-title="regionName" on-iron-select="_onRegionSelected">
                <template is="dom-repeat" items="[[_regions]]" as="region">
                  <paper-item region-name="[[region.name]]">[[region.name]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu><span class="field-spacer"
            ></span><paper-dropdown-menu id="venueSelector" label="Venue" disabled$="[[_disableVenueSelector]]">
              <paper-listbox class="dropdown-content" attr-for-selected="venueId" attr-for-item-title="venueId" on-iron-select="_onVenueSelected">
                <template is="dom-repeat" items="[[_venues]]" as="venue">
                  <paper-item venue-id="[[venue.id]]">[[venue.name]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <input type="hidden" id="venue" name="VenueId">
          </fieldset>

          <h4>Children</h4>
          <fieldset>
            <dom-if><template is="dom-if" if="[[doesArrayHaveValues(user.children)]]">
              <vaadin-grid items="{{user.children}}">
                <vaadin-grid-column width="auto">
                  <template class="header"><vaadin-grid-sorter path="first-name">First Name</vaadin-grid-sorter></template>
                  <template><paper-input class="field" no-label-float value="{{item.first-name}}" required></paper-input></template>
                </vaadin-grid-column>

                <vaadin-grid-column width="auto">
                  <template class="header"><vaadin-grid-sorter path="last-name">Last Name</vaadin-grid-sorter></template>
                  <template><paper-input class="field" no-label-float value="{{item.last-name}}" required></paper-input></template>
                </vaadin-grid-column>

                <vaadin-grid-column width="auto">
                  <template class="header"><vaadin-grid-sorter path="gender">Gender</vaadin-grid-sorter></template>
                  <template>
                    <vaadin-combo-box class="field" no-label-float items="[[genders]]" value="{{item.gender}}" required>
                      <div style="display: none;" class="clear-button"></div>
                    </vaadin-combo-box>
                  </template>
                </vaadin-grid-column>

                <vaadin-grid-column width="auto">
                  <template class="header"><vaadin-grid-sorter path="birthday">Birthday</vaadin-grid-sorter></template>
                  <template>
                    <paper-input class="field" no-label-float value="[[_formatBirthdayDate(item.birthday)]]" readonly required item-index="[[index]]" on-tap="_openBirthdayPopUp"></paper-input>
                  </template>
                </vaadin-grid-column>

                <vaadin-grid-column width="56px" flex-grow="0">
                  <template class="header"><div></div></template>
                  <template><paper-icon-button icon="delete" on-tap="_removeChild"></paper-icon></template>
                </vaadin-grid-column>
    					</vaadin-grid>
            </template></dom-if>

            <dom-if><template is="dom-if" if="[[!doesArrayHaveValues(user.children)]]">
              <div>No children on record.</div>
            </template></dom-if>

            <paper-button raised id="add-child-btn" no-children$="[[!doesArrayHaveValues(user.children)]]" on-tap="_addChild">Add Child</paper-button>
          </fieldset>
        </div>
        <div class="card-actions">
          <div id="submit-container">
            <span class="flex"></span>
            <div class="messgae" hidden$="[[!_saving]]">
              <paper-spinner id="spinner" active="[[_saving]]"></paper-spinner>
            </div>
            <paper-button id="save" raised disabled="[[_saving]]" on-tap="_submitForm">Save</paper-button>
            <paper-button id="cancel" raised disabled="[[_saving]]" on-tap="_restForm">Cancel</paper-button>
          </div>
        </div>
      </paper-card>
    </form>

    <gt-dialog id="birthday-dialog" with-backdrop>
      <paper-date-picker id="birthday-picker" style="margin:8px;padding:0;"></paper-datepicker>
    </gt-dialog>

  </template>

  <script>
    Polymer({
      is: 'gt-page-account',

      behaviors: [
        GT.ElementCommonBehavior,
        GT.PageBehavior,
        Polymer.IronA11yKeysBehavior
      ],

      keyBindings: {
        'enter': '_onEnter'
      },

      properties: {

        /**
         * The user must be logged in to view this page.
         */
        requiresLogin: {
          type: Boolean,
          value: true
        },

        /**
         * True if waiting for the form request response.
         */
        _saving: {
          type: Boolean,
          value: false
        },

        /**
         * The error message to display.
         */
        _formErrorMessage: {
          type: String,
          value: null
        },

        /**
         * The venue.
         */
        _venue: {
          type: Object,
          statePath: 'venue'
        },

        /**
         * A list of the regions the user can choose from.
         */
        _regions: {
          type: Array,
          observer: '_populateVenueSelector'
        },

        /**
         * A list of the venues in the selected region the user can choose from.
         */
        _venues: {
          type: Array
        }
      },

      /**
       * Submit the signin form.
       */
      _submitForm: function() {
        this.$.form.submit();
      },

      /**
       * Called when the signin form is submitted.
       */
      _onFormSubmit: function() {
        this._saving = true;
      },

      /**
       * Called when the server responds positively to signin form submition.
       */
      _onFormResponse: function(e) {
        if (!e.detail.response.successful) {
          this._onFormError(e);
        } else {
          this._saving = false;
          this.clearErrorMessage();
        }
      },

      /**
       * Called when an error occurs trying to submit the signin form.
       */
      _onFormError: function(e) {
        this._saving = false;

        var unknownErrorMessage = 'Unfortunately, an unknown error has occured.';
        if (e.detail.response) {
          switch (e.detail.response.errorCode) {
            // UNKNOWN
            default:
            case 1:
              this._formErrorMessage = unknownErrorMessage;
              break;

            // INVALID FORM
            case 2:
              this._formErrorMessage = 'Invalid form.';
              break;
          }
        } else {
          this._formErrorMessage = unknownErrorMessage;
        }
        this.focus();
      },

      _onEnter: function() {
        this._submitForm();
      },

      /**
       * Clear the error message.
       */
      clearErrorMessage: function() {
        this._formErrorMessage = null;
      },

      focus: function() {
        this.$['first-name'].focus();
      },

      /**
       * Populate the fields with data for the current user.
       */
      _populateFieldsForSignedInUser: function() {
        if (this.user.firstName) {
          this.$['first-name'].value = this.user.firstName;
        }
        if (this.user.lastName) {
          this.$['last-name'].value = this.user.lastName;
        }
        if (this.user.phone) {
          this.$['phone'].value = this.user.phone;
        }
        if (this.user.email) {
          this.$['email'].value = this.user.email;
        }
        this._populateVenueSelector();
      },

      /**
       * Populate the regionSelector and the venueSelector.
       */
      _populateVenueSelector: function() {
        setTimeout(function() {
          if (this.user.venue && this.user.venue.region && this.user.venue.id) {
            this.$.regionSelector.contentElement.select(this.user.venue.region);
            this.$.venueSelector.contentElement.select(this.user.venue.id);
          } else if (this._venue && this._venue.region && this._venue.id) {
            this.$.regionSelector.contentElement.select(this._venue.region);
            this.$.venueSelector.contentElement.select(this._venue.id);
          }
        }.bind(this), 0);
      },

      _onRegionSelected: function(e) {
        this.$['venue-selector'].selectRegion(e.detail.item.regionName);
        setTimeout(function() {
          if (this.$['venue-selector'].selectedVenueId) {
            this.$.venueSelector.contentElement.select(this.$['venue-selector'].selectedVenueId);
          }
        }.bind(this), 0);
      },

      _onVenueSelected: function(e) {
        this.$['venue-selector'].selectVenue(e.detail.item.venueId);
        this.$.venue.value = e.detail.item.venueId;
      },

      _formatBirthdayDate: function(date) {
        if (date instanceof Date) {
          return GT.getOrdinalOfNumber(date.getDate()).super + ' ' +
                 GT.monthLookUp[date.getMonth()].long + ' ' +
                 date.getFullYear();
         }
         return '';
      },

      _addChild: function() {
        this.dispatch('addChild');
        var cells = this.$.children.querySelectorAll('vaadin-grid-cell-content');
        var firstCellInLastRow = this.$.children.querySelector('#vaadin-grid-cell-content-' + (cells.length - 5));
        var field = firstCellInLastRow.querySelector('.field');
        field.focus();
      },

      _removeChild: function(e) {
        var index = this.user.children.indexOf(e.model.item);
        this.dispatch('removeChild', index);
        // this.$.children.clearCache();
      },

      _openBirthdayPopUp: function(e) {
        var index = e.target.itemIndex;
        var dialog = this.$['birthday-dialog'];
        dialog.open();
        var picker = dialog.dialogElement.querySelector('#birthday-picker');
        picker.date = e.model.item.birthday;
        picker.addEventListener('date-changed', function() {
          if (picker.date.getTime() !== e.model.item.birthday.getTime()) {
            this.dispatch('setChildBirthday', index, picker.date);
          }
        }.bind(this));
      },

      /**
       * Called when the page is switched back to.
       */
      onSwitchBackTo: function() {
        if (this.canView()) {
          this.displayPageTitle();
          this.clearErrorMessage();
          this._populateFieldsForSignedInUser();
        }
      },

      init: function() {
        if (this.canView()) {
          this.pageTitle = this.appConfig.pages.account.title;
          this.displayPageTitle();
          this._populateFieldsForSignedInUser();
          this.pageReady();
        }
      },

      ready: function() {
        this.init();
      }
    });
  </script>
</dom-module>
