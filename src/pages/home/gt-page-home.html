<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/neon-slideshow/neon-carousel-pages.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../../styles/gt-styles.html">
<link rel="import" href="../gt-page-behavior.html">

<link rel="import" href="gt-testimonial.html">

<dom-module id="gt-page-home">
  <template>
    <style include="gt-styles">
      :host {
        display: block;
      }
      neon-carousel-pages {
        position: relative;
        height: 50vh;
      }
      #title {
        text-align: center;
        font-size: 22pt;
        margin-top: 0.4em;
        margin-bottom: 0.25em;
      }
      #subtitle {
        text-align: center;
        font-size: 17pt;
        margin-top: 0;
        margin-bottom: 0.4em;
        line-height: 1.33;
      }
      .cards {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-start);
        @apply(--layout-center-justified);
        margin-bottom: 0.75em;
      }
      .cards > paper-card {
        margin: 0.75em 0.75em 0 0.75em;
        @apply(--layout-flex);
      }
      paper-card {
        min-width: 300px;
        max-width: 500px;
      }
      gt-testimonial {
        margin: 1em 0;
      }
      gt-testimonial:first-of-type {
        margin-top: 0;
      }
      gt-testimonial:last-of-type {
        margin-bottom: 0;
      }
      @media (min-width: 1280px) {
        #title {
          font-size: 28pt;
        }
        #subtitle {
          font-size: 22pt;
        }
      }
      @media (min-width: 2560px) {
        #title {
          font-size: 36pt;
        }
        #subtitle {
          font-size: 32pt;
        }
        paper-card {
          max-width: 750px;
        }
      }
    </style>

    <!-- Download data -->
    <iron-ajax
      id="pageDataLoader"
      url="[[app.dataPath]]home.json"
      handle-as="json"
      last-response="{{pageData}}"
      on-response="_handleAjaxResponse"
      on-error="_handleAjaxError"></iron-ajax>

    <!-- Layout -->
    <neon-carousel-pages id="carouselPages" playing delay="6000">
      <template is="dom-repeat" items="[[pageData.carouselImages]]" as="img">
        <iron-image sizing="cover" src="[[img.src]]" preload fade placeholder="[[img.placeholder]]"></iron-image>
      </template>
    </neon-carousel-pages>

    <h1 id="title">[[pageData.welcome]]</h1>
    <h2 id="subtitle">[[app.data.company.slogan]]</h2>

    <div class="cards">

      <paper-card heading="[[pageData.philosophy.heading]]">
        <div class="card-content"><html-echo html="[[pageData.philosophy.content]]"></html-echo></div>
      </paper-card>

      <paper-card heading="[[pageData.classes.heading]]">
        <div class="card-content"><html-echo html="[[pageData.classes.content]]"></html-echo></div>
        <div class="card-actions">
          <a name="classes" href$="[[app.data.pages.classes.url]]" tabindex="-1"><paper-button>Book Now</paper-button></a>
        </div>
      </paper-card>

      <paper-card heading="[[pageData.testimonials.heading]]">
        <div class="card-content">
          <template is="dom-repeat" items="[[pageData.testimonials.list]]" as="testimonial">
            <gt-testimonial content="[[testimonial.content]]" by="[[testimonial.by]]" date="[[testimonial.date]]"></gt-testimonial>
          </template>
        </div>
      </paper-card>

    </div>
  </template>

  <script>
    Polymer({
      is: 'gt-page-home',

      properties: {

        /**
         * The data the page will use.
         */
        pageData: Object,
      },

      behaviors: [GT.PageBehavior],

      observers: [
        '_carouselImagesChanged(pageData.carouselImages)'
      ],

      /**
       * Initialise the page.
       */
      init: function() {
        this.$.pageDataLoader.generateRequest();
      },

      /**
       * Returns whether or not the given object has the given key and the key's value is truthy.
       *
       * {Object} obj
       * {String} key
       */
      _hasKeyValue: function(obj, key) {
        return obj.hasOwnProperty(key) && obj[key];
      },

      /**
       * Called when the carousel images are changed.
       */
      _carouselImagesChanged: function(images) {
        // add or remove a placeholder child so that the neon-carousel-pages element
        // never has no displayable children

        var dom = Polymer.dom(this.$.carouselPages);

        if (images && images.length > 0) {
          var placeholder = dom.querySelector('.placeholder');
          if (placeholder) {
            dom.removeChild(placeholder);
          }
        } else {
          var placeholder = document.createElement('div');
          placeholder.setAttribute('class', 'placeholder');
          dom.insertBefore(placeholder, dom.firstChild);
        }
      },

      /**
       * Called when the page data loads.
       */
      _handleAjaxResponse: function() {
        this.pageReady();
      },

      /**
       * Called when an error occurs during the ajax request.
       */
      _handleAjaxError: function() {
        this.pageError();
      },

      ready: function() {
        this.init();
      }
    });
  </script>
</dom-module>
