<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/cascaded-animation.html">

<link rel="import" href="../../../styles/gt-styles.html">
<link rel="import" href="../../../imports/gt.html">
<link rel="import" href="../../animations/scale-up-and-fade-in-animation.html">
<link rel="import" href="../../gt-element-common-behavior.html">
<link rel="import" href="../gt-page-behavior.html">

<dom-module id="gt-page-signin">
  <template>
    <style include="gt-styles">
      :host {
        display: block;
        @apply(--layout-horizontal);
        @apply(--layout-start);
        @apply(--layout-center-justified);
      }
      #cards {
        @apply(--layout-vertical);
        @apply(--layout-center);
        margin: 0 0.5em;
        width: calc(100% - 1em);
        max-width: 1140px;
      }
      .card {
        margin: 0.75em 0.25em 0 0.25em;
        width: calc(100% - 0.5em);
        max-width: 400px;
        box-sizing: border-box;
      }
      #signin-card .card-content,
      #signup-card .card-content {
        padding: 0 16px 16px 16px;
      }
      #signin-card .card-actions,
      #signup-card .card-actions {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }
      #signin-card {

      }
      #signup-card {

      }
      a {
        cursor: pointer;
      }
      .signup-notice {
        text-align: center;
        padding-left: 8px;
      }
      .card paper-button {
        margin: 0;
      }
      @media (min-width: 640px) {
        #cards {
          margin: 0.25em 0.5em 0 0.5em;
        }
        .card {
          min-width: 350px;
        }
      }
      @media (min-width: 1280px) {
        .card {
          max-width: 500px;
        }
      }
    </style>

    <!-- Layout -->
    <div id="cards">
      <paper-card id="signin-card" class="card" heading="[[appConfig.pages.signin.title]]" hidden$="[[!_isVisibleCard('signin', _visibleCard)]]">
        <div class="card-content">
          <paper-input id="signin-email" class="field" name="email" type="email" label="Email Address" auto-validate required autofocus></paper-input>
          <paper-input id="signin-password" class="field" name="password" type="password" label="Password" auto-validate required></paper-input>
        </div>
        <div class="card-actions">
          <div class="signup-notice">Don't have an account?<br><a on-tap="_showSignUp">Sign Up</a> now.</div>
          <paper-button raised on-tap="_signin">[[appConfig.pages.signin.title]]</paper-button>
        </div>
      </paper-card>

      <paper-card id="signup-card" class="card" heading="Sign Up" hidden$="[[!_isVisibleCard('signup', _visibleCard)]]">
        <div class="card-content">
          <paper-input id="signup-email" class="field" name="email" type="email" label="Email Address" auto-validate required></paper-input>
          <paper-input id="signup-password" class="field" name="password" type="password" label="Password" auto-validate required></paper-input>
          <paper-input id="signup-password2" class="field" type="password" label="Password Confirm" auto-validate required></paper-input>
        </div>
        <div class="card-actions">
          <div class="signup-notice">Already have an account?<br><a on-tap="_showSignIn">[[appConfig.pages.signin.title]]</a> now.</div>
          <paper-button raised on-tap="_signup">Sign Up</paper-button>
        </div>
      </paper-card>

      <paper-card id="signedin-card" class="card" heading="You are now signed in" hidden$="[[!_isVisibleCard('signedin', _visibleCard)]]">
        <div class="card-content">
          <span>You are currently signed in as [[_user.name]]</span>
        </div>
        <div class="card-actions">
          <paper-button raised on-tap="_signout">Log Out</paper-button>
        </div>
      </paper-card>
    </div>
  </template>

  <script>
    Polymer({
      is: 'gt-page-signin',

      behaviors: [
        GT.ElementCommonBehavior,
        GT.PageBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {

        /**
         * The data the page will use.
         */
        pageData: Object,


        /**
         * The card that should be shown.
         */
        _cardToShow: {
          type: String,
          value: 'signin'
        },

        /**
         * The card that is visible.
         */
        _visibleCard: {
          type: String,
          computed: '_computeVisibleCard(_cardToShow, _user)'
        },

        /**
         * The signed in user
         */
        _user: {
          type: Object,
          statePath: 'signedInUser'
        },

        /**
         * The animations this element has.
         */
         animationConfig: {
           value: function() {
             return {
               entry: {
                 name: 'cascaded-animation',
                 animation: 'scale-up-and-fade-in-animation',
                 nodes: Polymer.dom(this.root).querySelectorAll('paper-card'),
                 nodeDelay: GT.animation.timingOffset,
                 timing: {
                   delay: 0,
                   duration: GT.animation.entryDuration
                 }
               }
             };
           }
         }
      },

      /**
       * Called when the signin button is clicked.
       */
      _signin: function() {
        this.$['signin-email'].validate();
        this.$['signin-password'].validate();

        if (!(this.$['signin-email'].invalid ||
        this.$['signin-password'].invalid)) {
          console.log('todo: signin');
          this.dispatch('signIn', {
            name: 'Test User'
          });
          this.$['signin-password'].value = '';
        }
      },

      /**
       * Called when the signup button is clicked.
       */
      _signup: function() {
        this.$['signup-email'].validate();
        this.$['signup-password'].validate();

        // make sure the passwords match
        if (this.$['signup-password'].value !== this.$['signup-password2'].value) {
          this.$['signup-password'].invalid = true;
          this.$['signup-password2'].invalid = true;
        }

        if (!(this.$['signup-email'].invalid ||
        this.$['signup-password'].invalid)) {
          console.log('todo: signup');
        }
      },

      /**
       * Sign out the user.
       */
      _signout: function() {
        this.dispatch('signOut');
      },

      /**
       * Computer the visible card.
       */
      _computeVisibleCard: function(cardToShow, user) {
        if (user === null) {
          return cardToShow;
        }
        return 'signedin';
      },

      /**
       * Test if the given cardName is the visible card.
       *
       * @param String cardName
       * @param String visibleCard
       * @returns Boolean
       */
      _isVisibleCard: function(cardName, visibleCard) {
        return cardName === visibleCard;
      },

      /**
       * Show the sign in card.
       */
      _showSignIn: function() {
        this._cardToShow = 'signin';
        Polymer.dom(this.$['signin-card']).querySelector('paper-input').focus();
      },

      /**
       * Show the sign up card.
       */
      _showSignUp: function() {
        this._cardToShow = 'signup';
        Polymer.dom(this.$['signup-card']).querySelector('paper-input').focus();
      },

      /**
       * Called when the page is switched back to.
       */
      onSwitchBackTo: function() {
        this.displayPageTitle();
        this._showSignIn();
        this.playAnimation('entry');
      },

      /**
       * Initialise the page.
       */
      init: function() {
        this.pageTitle = this.appConfig.pages.signin.title;
        this.displayPageTitle();
        this.pageReady();
        this.playAnimation('entry');
      },

      ready: function() {
        this.init();
        Polymer.dom(this.root).querySelectorAll('.field').forEach(function(e) {
          e.onblur = GT.onFieldBlur;
        });
      }
    });
  </script>
</dom-module>
