<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../../../styles/gt-styles.html">
<link rel="import" href="../../../imports/gt.html">
<link rel="import" href="../../gt-element-common-behavior.html">

<dom-module id="gt-signin-card">
  <template>
    <style include="gt-styles">
      :host {
        display: block;
      }
      form {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }
      a {
        cursor: pointer;
      }
      paper-button {
        margin: 0;
      }
      #card {
        width: 100%;
      }
      #card .card-content {
        padding: 0 16px 16px 16px;
      }
      #card .card-actions {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }
      #error-message {
        background: #f2dede;
        border: solid 1px #ebccd1;
        border-radius: 4px;
        color: #d8000c;
        margin: 8px 0px;
        padding: 8px 16px;
      }
      #remember {
        margin: 16px 0 0 0;
        font-size: 10.5pt;
      }
      #notice {
        text-align: center;
        padding-left: 8px;
      }
      #submit-container {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        overflow: hidden;
      }
      #submit-container .messgae {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin-right: 16px;
      }
    </style>

    <!-- Layout -->
    <form is="iron-form"
      id="form"
      method="post"
      action="[[getApiUrl(appConfig.form-handlers.signin)]]"
      on-iron-form-submit="_formSubmit"
      on-iron-form-error="_formError"
      on-iron-form-response="_formResponse">
      <paper-card id="card" heading="[[appConfig.pages.signin.title]]">
        <div class="card-content">
          <paper-material id="error-message" hidden$="[[!isDefined(_formErrorMessage)]]">[[_formErrorMessage]]</paper-material>
          <paper-input id="email" class="field" name="Email" type="email" label="Email Address" auto-validate required autofocus></paper-input>
          <paper-input id="password" class="field" name="Password" type="password" label="Password" auto-validate required></paper-input>
          <paper-checkbox id="remember">Remember Me?</paper-checkbox>
        </div>
        <div class="card-actions">
          <div id="notice">Don't have an account?<br><a on-tap="_showSignUpCard">Sign Up</a> now.</div>
          <div id="submit-container">
            <div class="messgae" hidden$="[[!_signingIn]]">
              <paper-spinner id="spinner" active="[[_signingIn]]"></paper-spinner>
            </div>
            <paper-button id="signin" raised disabled="[[_signingIn]]" on-tap="_submitForm">[[appConfig.pages.signin.title]]</paper-button>
          </div>
        </div>
      </paper-card>
    </form>
  </template>

  <script>
    Polymer({
      is: 'gt-signin-card',

      behaviors: [
        GT.ElementCommonBehavior,
        Polymer.IronA11yKeysBehavior
      ],

      keyBindings: {
        'enter': '_onEnter'
      },

      properties: {

        /**
         * The page this card is on.
         */
        page: Object,

        /**
         * The back url.
         */
        backUrl: {
          type: String,
          statePath: 'signinBackUrl'
        },

        /**
         * True if waiting for the signin request response.
         */
        _signingIn: {
          type: Boolean,
          value: false
        },

        /**
         * The error message to display.
         */
        _formErrorMessage: {
          type: String,
          value: null
        }
      },

      /**
       * Submit the signin form.
       */
      _submitForm: function() {
        this.$.form.submit();
      },

      /**
       * Called when the signin form is submitted.
       */
      _formSubmit: function() {
        this._signingIn = true;
        this._rememberMe = this.$.remember.checked;
      },

      /**
       * Called when the server response positively to signin form submition.
       */
      _formResponse: function(e) {
        if (!e.detail.response.successful) {
          this._formError(e);
        } else {
          this._signingIn = false;
          this.clearErrorMessage();
          this.dispatch(
            'signIn',
            e.detail.response['new-id-token'],
            this._rememberMe,
            e.detail.response['first-name'],
            e.detail.response['last-name']);
          this.$.password.value = '';
          if (this.backUrl !== null) {
            window.history.pushState({}, null, this.backUrl);
            window.dispatchEvent(new CustomEvent('location-changed'));
            this.dispatch('clearSigninBackUrl');
          }
        }
      },

      /**
       * Called when an error occurs trying to submit the signin form.
       */
      _formError: function(e) {
        this._signingIn = false;
        switch (e.detail.response.errorCode) {
          // UNKNOWN
          default:
          case 1:
            this._formErrorMessage = 'Unfortunately, an unknown error has occured.';
            break;

          // INVALID FORM
          case 2:
            this._formErrorMessage = 'Invalid form.';
            break;

          // BAD CREDENTIALS
          case 3:
          this._formErrorMessage = 'Bad Credentials: Invalid email/password.';
            break;
        }
        this.focus();
      },

      /**
       * Show the sign up card.
       */
      _showSignUpCard: function() {
        this.page.showSignUpCard();
      },

      _onEnter: function() {
        this._submitForm();
      },

      /**
       * Clear the error message.
       */
      clearErrorMessage: function() {
        this._formErrorMessage = null;
      },

      focus: function() {
        this.$.email.focus();
      },

      ready: function() {
        Polymer.dom(this.root).querySelectorAll('.field').forEach(function(e) {
          e.onblur = GT.onFieldBlur;
        });
      }
    });
  </script>
</dom-module>
