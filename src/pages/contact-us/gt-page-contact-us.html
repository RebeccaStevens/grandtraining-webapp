<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../bower_components/html-echo/html-echo.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../../../styles/gt-styles.html">
<link rel="import" href="../../../imports/gt.html">
<link rel="import" href="../../../imports/recaptcha.html">
<link rel="import" href="../../gt-element-common-behavior.html">
<link rel="import" href="../../animations/scale-up-and-fade-in-animation.html">
<link rel="import" href="../gt-page-behavior.html">

<dom-module id="gt-page-contact-us">
  <template>
    <style include="gt-styles">
    :host {
      display: block;
      @apply(--layout-vertical);
      @apply(--layout-center);
    }
    #card {
      background-color: #ffffff;
      margin: 0.75em;
      padding: 8px;
      width: calc(100% - 1.5em);
      max-width: 1140px;
      box-sizing: border-box;
      --paper-card-header-text: {
        color: var(--app-secondary-header-color);
        padding: 4px 12px;
        font-size: var(--app-header-1-font-size);
      };
    }
    #card > .card-content {
      padding: 0 8px 6px 8px;
    }
    #form {
      overflow: hidden;
    }
    .field {
      --paper-input-container: {
        padding: 16px 0;
      };
      --paper-input-container-label: {
        font-weight: 400;
        letter-spacing: 0.75px;
      };
      --paper-input-container-label-floating: {
        transform: translateY(-100%) scale(1);
      };
    }
    .field:first-child {
      --paper-input-container: {
        padding: 8px 0;
      };
    }
    .inline.field {
      width: 100%;
      max-width: 713px;
    }
    paper-dropdown-menu.inline.field {
      --paper-menu-button-dropdown: {
        width: 100%;
        max-width: calc(100% - 1.5em - 32px);
        transform: initial;
      };
    }
    .send.button {
      display: block;
      margin: 0;
    }
    .submit-container {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      margin: 16px 0 2px 0;
    }
    .sending-messgae {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      margin-left: 16px;
    }
    #spinner {
      margin-right: 12px;
    }
    @media (min-width: 768px) {
      paper-dropdown-menu.inline.field {
        --paper-menu-button-dropdown: {
          width: 100%;
          max-width: 689px;
          transform: translateX(-24px) translateY(24px);
        };
      }
    }
    </style>

    <!-- Download data -->
    <iron-ajax
      id="pageDataLoader"
      url="[[app.dataPath]]contact-us.json"
      handle-as="json"
      last-response="{{pageData}}"
      on-response="_handleAjaxResponse"
      on-error="_handleAjaxError"></iron-ajax>

    <paper-card id="card" heading="Send us a Message">
      <div class="card-content">
        <form is="iron-form" id="form" method="post" action="[[app.data.pages.contact-us.url]]/formhandler">
          <paper-input class="inline field"
            name="name"
            label="Full Name:"
            tpye="text"
            always-float-label
            minlength="2"
            maxlength="70"
            required
            auto-validate
            error-message="Please provide your full name"
            autofocus></paper-input>
          <paper-input class="inline field"
            name="phone"
            label="Phone:"
            type="tel"
            minlength="9"
            maxlength="15"
            always-float-label
            required
            auto-validate
            allowed-pattern="[0-9]"
            error-message="Please provide your phone number (inlcude your Area Code)"></paper-input>
          <paper-input class="inline field"
            name="email"
            label="Email Address:"
            type="email"
            always-float-label
            required
            auto-validate
            error-message="Please provide your email address"></paper-input>
          <paper-dropdown-menu class="inline field"
            name="location"
            label="Your Location:"
            always-float-label
            required
            auto-validate
            error-message="Please select your location">
            <paper-listbox class="dropdown-content">
              <template is="dom-repeat" items="[[pageData.locations]]" as="location">
                <paper-item>[[location.fullname]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-input class="inline field"
            name="subject"
            label="Subject:"
            tpye="text"
            always-float-label
            minlength="2"
            maxlength="128"
            required
            auto-validate
            error-message="Please provide a subject for your message"
            autofocus></paper-input>
          <paper-textarea class="field"
            name="message"
            label="Message:"
            always-float-label
            minlength="20"
            maxlength="2048"
            char-counter
            required
            auto-validate
            error-message="Please a message of at least 20 characters"></paper-textarea>
          <div id="recaptcha-spaceholder"></div>
          <input
            name="g-recaptcha-response"
            type="hidden">
          <div class="submit-container">
            <paper-button id="send" class="button send" raised disabled="[[_sendingMessage]]" on-tap="_submitForm">Send Message</paper-button>
            <div class="sending-messgae" hidden$="[[!_sendingMessage]]">
              <paper-spinner id="spinner" active="[[_sendingMessage]]"></paper-spinner>
              <span>Sending</span>
            </div>
          </div>
        </form>
      </div>
    </paper-card>

    <paper-dialog id="message-sent-dialog" with-backdrop>
      <h2>Message Sent</h2>
      <paper-dialog-scrollable>
        <html-echo html="[[pageData.confirmationMessage]]"></html-echo>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>Close</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="error-dialog" with-backdrop>
      <h2>Error</h2>
      <paper-dialog-scrollable>
        <html-echo html="[[pageData.errorMessage]]"></html-echo>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>Close</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    Polymer({
      is: 'gt-page-contact-us',

      behaviors: [
        GT.ElementCommonBehavior,
        GT.PageBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {
        /**
         * True when a messages is being sent.
         */
        _sendingMessage: {
          type: Boolean,
          value: false
        },

        /**
         * The animations this element has.
         */
        animationConfig: {
          type: Object,
          value: function() {
            return {
              entry: {
                name: 'scale-up-and-fade-in-animation',
                node: this,
                transformOrigin: '50% 50%',
                timing: {
                  delay: 0,
                  duration: GT.animation.entryDuration
                }
              },
              exit: {
                name: 'fade-out-animation',
                node: this,
                timing: {
                  delay: 0,
                  duration: GT.animation.exitDuration
                }
              }
            };
          }
        }
      },

      listeners: {
        'iron-form-error': '_formError',
        'iron-form-submit': '_formSubmit',
        'iron-form-response': '_formResponse'
      },

      /**
       * Called when the form is submitted.
       */
      _submitForm: function() {
        this.$.form.submit();
      },

      /**
       * Called when an error occurs trying to submit the form.
       */
      _formError: function() {
        this._sendingMessage = false;
        this.$['error-dialog'].open();
      },

      /**
       * Called when the form is submitted.
       */
      _formSubmit: function() {
        this._sendingMessage = true;
      },

      /**
       * Called when the server response positively to form submition.
       */
      _formResponse: function() {
        this._sendingMessage = false;
        this.$['message-sent-dialog'].open();
        this.$.form.reset();
      },

      /**
       * Create the Recaptcha Element.
       *
       * Note that the Recaptcha Element doesn't work inside shadow dom.
       * As a workaround, it is created at the document level and then position to look like it's in this element.
       */
      _createRecaptchaElement: function() {
        this._recaptchaEl = document.createElement('div');
        document.body.appendChild(this._recaptchaEl);
        this._grecaptchaId = window.grecaptcha.render(this._recaptchaEl, {
          sitekey: this.pageData.recaptchaConfig.sitekey,
          theme: 'light',
          callback: function(response) {
            Polymer.dom(this.root).querySelector('[name="g-recaptcha-response"]').value = response;
          }.bind(this)
        });

        this._recaptchaEl.style.position = 'fixed';
        this.$['recaptcha-spaceholder'].style.width = this._recaptchaEl.clientWidth + 'px';
        this.$['recaptcha-spaceholder'].style.height = this._recaptchaEl.clientHeight + 8 + 'px';

        this._updateRecaptchaPosition();
        window.addEventListener('resize', this._updateRecaptchaPosition.bind(this));
        window.addEventListener('scroll', this._updateRecaptchaPosition.bind(this));
      },

      /**
       * Update the Recaptcha Element's position.
       */
      _updateRecaptchaPosition: function() {
        var bcr = this.$['recaptcha-spaceholder'].getBoundingClientRect();
        this._recaptchaEl.style.top = bcr.top + 8 + 'px';
        this._recaptchaEl.style.right = bcr.right + 'px';
        this._recaptchaEl.style.bottom = bcr.bottom + 'px';
        this._recaptchaEl.style.left = bcr.left + 'px';
      },

      /**
       * Initialise the page.
       */
      init: function() {
        this.$.pageDataLoader.generateRequest();
      },

      /**
       * Called when the page is switched back to.
       */
      onSwitchBackTo: function() {
        this.playAnimation('entry');

        this.$.form.reset();
        if (this._recaptchaEl !== undefined ) {
          this.async(function() {
            this._recaptchaEl.style.display = 'block';
          }, GT.animation.entryDuration);
        }
        if (window.grecaptcha !== undefined && this._grecaptchaId !== undefined ) {
          window.grecaptcha.reset(this._grecaptchaId);
        }

        // focus the first field
        this.async(function() {
          Polymer.dom(this.$.form).querySelector('.field').focus();
        }, 0);
      },

      /**
       * Called when the page is switched away from.
       */
      onSwitchFrom: function() {
        this.playAnimation('exit');

        if (this._recaptchaEl) {
          this._recaptchaEl.style.display = 'none';
        }
      },

      /**
       * Called when the page data loads.
       */
      _handleAjaxResponse: function() {
        if (this.pageData) {
          this.async(function() {
            if (window.grecaptcha === undefined) {
              document.addEventListener('recaptcha-ready', this._createRecaptchaElement.bind(this));
            } else {
              this._createRecaptchaElement();
            }
          }, GT.animation.entryDuration);

          this.playAnimation('entry');
          this.pageReady();
        } else {
          this._handleAjaxError();
        }
      },

      /**
       * Called when an error occurs during the ajax request.
       */
      _handleAjaxError: function() {
        this.pageError();
      },

      ready: function() {
        this.init();
      }
    });
  </script>
</dom-module>
